<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Webcam + An√°lisis en Vivo con Barra Pegada</title>

<style>
body{margin:0;font-family:sans-serif;background:#eee}
#main{display:flex;height:60vh}
#left,#right{flex:1;padding:4px}

/* ===== VIDEO + CRUCETA ===== */
.video-box{
  position:relative;
  width:100%;
  height:100%;
}
video{
  width:100%;
  height:100%;
  object-fit:cover;
  background:black;
}
.crosshair{
  position:absolute;
  inset:0;
  pointer-events:none;
  --c-color:red;
  --c-size:2px;
}
.crosshair::before,
.crosshair::after{
  content:"";
  position:absolute;
  background:var(--c-color);
}
.crosshair::before{
  left:50%;
  top:0;
  width:var(--c-size);
  height:100%;
  transform:translateX(-50%);
}
.crosshair::after{
  top:50%;
  left:0;
  height:var(--c-size);
  width:100%;
  transform:translateY(-50%);
}

/* ===== CONTROLES ===== */
#controls{
  display:flex;gap:8px;justify-content:center;
  align-items:center;padding:6px;flex-wrap:wrap;
}

button{height:44px;font-size:18px;cursor:pointer}
.control-btn{width:44px}
.speed-btn{width:64px;font-size:16px}
.speed-btn.active{background:orange}

input[type=range]{width:120px}
select{height:32px}

#recTime{text-align:center;font-size:14px;color:red;display:none}
#info{text-align:center;font-size:14px}

#graphCanvas{
  width:100%;
  height:170px;
  background:#fff;
  cursor:pointer;
}

#fileList{
  background:#333;color:#fff;
  padding:5px;max-height:25vh;overflow:auto;
}
.file-row{display:flex;gap:4px;align-items:center}
.file-btn{
  flex:1;
  background:#444;
  color:#ddd;
  border:2px solid #222;
  padding:6px;
  text-align:left;
  font-weight:bold;
  cursor:pointer;
}
.file-btn:hover{background:#555}
.file-btn.active{
  background:orange;
  color:white;
  border-color:#2b1a00;
}
.save-btn{
  width:36px;height:36px;background:#666;color:#fff;border:none;cursor:pointer;
}
#openFileBtn {
    width: 44px;       /* igual que los otros botones */
    height: 44px;
    font-size: 24px;   /* tama√±o del icono */
    cursor: pointer;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
}
</style>
</head>

<body>

<div id="main">
  <div id="left">
    <div class="video-box">
      <video id="camVideo" muted autoplay></video>
      <div class="crosshair"></div>
    </div>
  </div>
  <div id="right">
    <video id="playVideo" controls></video>
  </div>
</div>

<div id="controls">

  <span>| Cruceta</span>
  <select id="crossColor">
    <option value="orange">Naranja</option>
    <option value="red" selected>Rojo</option>
    <option value="black">Negro</option>
    <option value="white">Blanco</option>
    <option value="purple">Morado</option>
  </select>
  <input id="crossSize" type="range" min="1" max="5" value="2">
  <span id="crossSizeVal">2 px</span>

  <button id="camBtn" class="control-btn">üì∑</button>
  <button id="recBtn" class="control-btn">‚è∫</button>
<span id="counterDisplay" title="Pr√≥ximo video"
      style="font-weight:bold;font-size:16px;margin-left:6px;color:#333">
  #01
</span>
  <button id="saveBtn" class="control-btn">üíæ</button>
<button id="openFileBtn" class="control-btn">üìÇ</button>
<button id="resetCounterBtn" class="control-btn" title="Reiniciar numeraci√≥n">üîÅ</button>

<input id="fileInput" type="file" accept="video/*" hidden>

<button id="frameBackBtn" class="control-btn">‚è™</button>

<button id="playPauseBtn" class="control-btn">‚ñ∂Ô∏è</button>

<button id="frameForwardBtn" class="control-btn">‚è©</button>

<span>| Velocidad</span>

  <button class="speed-btn active" data-speed="1">1√ó</button>
  <button class="speed-btn" data-speed="0.5">0.5√ó</button>
  <button class="speed-btn" data-speed="0.25">0.25√ó</button>
  <button class="speed-btn" data-speed="0.1">0.1√ó</button>

</div>

<div id="recTime">‚è∫ Grabando: <span id="recClock">00:00.00</span></div>
<div id="info">Pico: <span id="peakTime">‚Äî</span></div>

<canvas id="graphCanvas"></canvas>
<div id="fileList"></div>
<script>
/* ===== ELEMENTOS ===== */
const camVideo = document.getElementById("camVideo");
const playVideo = document.getElementById("playVideo");
const canvas = document.getElementById("graphCanvas");
const ctx = canvas.getContext("2d");
const fileList = document.getElementById("fileList");
const peakLabel = document.getElementById("peakTime");

const camBtn = document.getElementById("camBtn");
const recBtn = document.getElementById("recBtn");
const saveBtn = document.getElementById("saveBtn");
const speedBtns = document.querySelectorAll(".speed-btn");

const recTimeBox = document.getElementById("recTime");
const recClock = document.getElementById("recClock");

const playPauseBtn = document.getElementById("playPauseBtn");

const frameBackBtn = document.getElementById("frameBackBtn");
const frameForwardBtn = document.getElementById("frameForwardBtn");

/* ===== CRUCETA ===== */
const crosshair = document.querySelector(".crosshair");
const crossColor = document.getElementById("crossColor");
const crossSize = document.getElementById("crossSize");
const crossSizeVal = document.getElementById("crossSizeVal");

function updateCrosshair() {
    crosshair.style.setProperty("--c-color", crossColor.value);
    crosshair.style.setProperty("--c-size", crossSize.value + "px");
    crossSizeVal.textContent = crossSize.value + " px";
}
crossColor.onchange = updateCrosshair;
crossSize.oninput = updateCrosshair;
updateCrosshair();

/* ===== ESTADO ===== */
let stream = null, recorder = null, chunks = [], recording = false;
let diffs = [], smoothDiffs = [], maxDiff = 1, peakIndex = 0;
let sensitivity = 1;
let lastLum = null, lastColor = null;
let currentVideo = null;
let autoFollow = true;

let videoCounter = 0; // empieza en 0 a prop√≥sito

const counterDisplay = document.getElementById("counterDisplay");

function updateCounterDisplay() {
    counterDisplay.textContent =
        "#" + String(videoCounter).padStart(2, "0");
}
updateCounterDisplay();

const resetCounterBtn = document.getElementById("resetCounterBtn");

resetCounterBtn.onclick = () => {
    if (recording) {
        alert("No puedes reiniciar el contador mientras grabas.");
        return;
    }

    if (confirm("¬øReiniciar la numeraci√≥n de videos a 01?")) {
        videoCounter = 0;
        updateCounterDisplay();
    }
};

/* ===== ANALIZADOR EN VIVO ===== */
let liveCanvas = document.createElement("canvas");
liveCanvas.width = 96; liveCanvas.height = 54;
let liveCtx = liveCanvas.getContext("2d", { willReadFrequently: true });
let liveTimer = null;
let sampleInterval = 120;

/* ===== UTIL ===== */
function smooth(data, r = 3) {
    return data.map((_, i) => {
        let s = 0, c = 0;
        for (let j = i - r; j <= i + r; j++) {
            if (data[j] != null) { s += data[j]; c++; }
        }
        return s / c;
    });
}
function formatTime(ms) {
    const s = ms / 1000, m = Math.floor(s / 60);
    return `${String(m).padStart(2, "0")}:${(s % 60).toFixed(2).padStart(5,"0")}`;
}

/* ===== VELOCIDAD ===== */
function setSpeed(v) {
    playVideo.playbackRate = v;
    speedBtns.forEach(b => b.classList.remove("active"));
    [...speedBtns].find(b => +b.dataset.speed === v)?.classList.add("active");
}
speedBtns.forEach(b => b.onclick = () => setSpeed(+b.dataset.speed));

/* ===== PLAY / PAUSE ===== */
playPauseBtn.onclick = () => {
    if (!playVideo.src) return;

    if (playVideo.paused) {
        playVideo.play();
        playPauseBtn.textContent = "‚è∏Ô∏è";
        autoFollow = false;
    } else {
        playVideo.pause();
        playPauseBtn.textContent = "‚ñ∂Ô∏è";
    }
};

// sincroniza el icono si el video se pausa solo
playVideo.onpause = () => playPauseBtn.textContent = "‚ñ∂Ô∏è";
playVideo.onplay  = () => playPauseBtn.textContent = "‚è∏Ô∏è";

/* ===== FRAME A FRAME ===== */

// duraci√≥n estimada de un frame (30 fps por defecto)
function frameStep(dir) {
    if (!playVideo.duration) return;

    playVideo.pause();
    playPauseBtn.textContent = "‚ñ∂Ô∏è";
    autoFollow = false;

const step = 0.005; // 5 ms

    let t = playVideo.currentTime + dir * step;
    t = Math.max(0, Math.min(t, playVideo.duration));
    playVideo.currentTime = t;
}

frameBackBtn.onclick    = () => frameStep(-1);
frameForwardBtn.onclick = () => frameStep(1);

/* ===== WEBCAM ===== */
camBtn.onclick = async () => {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        camVideo.srcObject = null;
        stream = null;
        camBtn.style.background = "";
        return;
    }
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        camVideo.srcObject = stream;
        camBtn.style.background = "orange";
    } catch (e) {
        alert("No se pudo acceder a la c√°mara");
    }
};

/* ===== GRABACI√ìN ===== */
let recStart, recTimer;

recBtn.onclick = () => recording ? stopRec() : startRec();

function formatDateForFilename(d = new Date()) {
    const pad = n => String(n).padStart(2, "0");
    return (
        d.getFullYear() +
        pad(d.getMonth() + 1) +
        pad(d.getDate()) +
        "_" +
        pad(d.getHours()) +
        pad(d.getMinutes()) +
        pad(d.getSeconds())
    );
}

function startRec() {
    if (!stream) return alert("Activa la webcam");

    chunks = []; diffs = []; smoothDiffs = [];
    maxDiff = 1; peakIndex = 0; lastLum = null; lastColor = null;
    autoFollow = true;

    videoCounter++;          // ‚¨ÖÔ∏è aumenta AL GRABAR
    recording = true;
    updateCounterDisplay();  // ahora muestra 01 en la primera grabaci√≥n

    recorder = new MediaRecorder(stream);
    recorder.ondataavailable = e => chunks.push(e.data);
recorder.onstop = async () => {
    if (!chunks.length) return;

    const blob = new Blob(chunks, { type: "video/webm" });
    const url = URL.createObjectURL(blob);

    const v = { 
        url,
        name: `grabacion_${formatDateForFilename()}_${String(videoCounter).padStart(2,"0")}.webm`,
        blob,
        smoothDiffs: [],
        peakIndex: 0
    };

    addToList(v);

    // üî• AN√ÅLISIS FINAL (IGUAL QUE BOT√ìN üìÇ)
    await new Promise(resolve => analyzeVideoFile(v, resolve));

    selectVideo(v);
    currentVideo = v;
};

    recorder.start();
    recording = true;
    recStart = performance.now();
    recTimeBox.style.display = "block";
    recTimer = setInterval(() => {
        recClock.textContent = formatTime(performance.now() - recStart);
    }, 50);

   startLiveAnalysis();

    // Cambiar color de bot√≥n y contador al grabar
    recBtn.style.background = "red";
    counterDisplay.style.color = "red"; // ‚úÖ contador rojo
}

function stopRec() {
    if (!recorder) return;
    recorder.stop();
    recording = false;

    clearInterval(recTimer);
    stopLiveAnalysis();
    recTimeBox.style.display = "none";
    recBtn.style.background = "";
    counterDisplay.style.color = "#333"; // ‚úÖ volver al color original
    autoFollow = false;
}

/* ===== BOT√ìN PRINCIPAL DE GUARDAR ===== */
saveBtn.onclick = () => {
    if (!currentVideo) return alert("No hay video para guardar. Primero graba uno.");
    const a = document.createElement("a");
    a.href = URL.createObjectURL(currentVideo.blob);
    a.download = currentVideo.name;
    a.click();
};

/* ===== AN√ÅLISIS ===== */
/* ===== ANALIZADOR EN VIVO con requestVideoFrameCallback ===== */
let liveRunning = false;

function analyzeLiveFrame(now, metadata) {
    if (!stream) return;

    // Dibujar el frame actual
    liveCtx.drawImage(camVideo, 0, 0, liveCanvas.width, liveCanvas.height);

    const d = liveCtx.getImageData(0,0,liveCanvas.width,liveCanvas.height).data;
    let lum = 0, r = 0, g = 0, b = 0;
    const n = d.length / 4;

    for (let i = 0; i < d.length; i += 4) {
        r += d[i]; g += d[i+1]; b += d[i+2];
        lum += 0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2];
    }

    lum /= n; r/=n; g/=n; b/=n;

    if (lastLum != null) {
        diffs.push(Math.abs(lum - lastLum) + Math.hypot(r-lastColor[0], g-lastColor[1], b-lastColor[2]) * 0.5);
        smoothDiffs = smooth(diffs, 3);
        recomputePeak();
    }

    lastLum = lum;
    lastColor = [r,g,b];

    // Solicitar el siguiente frame
    if (liveRunning) {
        camVideo.requestVideoFrameCallback(analyzeLiveFrame);
    }
}

function startLiveAnalysis() {
    if (!liveRunning) {
        liveRunning = true;
        camVideo.requestVideoFrameCallback(analyzeLiveFrame);
    }
}

function stopLiveAnalysis() {
    liveRunning = false;
}

/* ===== PICO ===== */
function recomputePeak(){
    maxDiff=1; peakIndex=0;
    smoothDiffs.forEach((d,i)=>{ 
        const v=Math.pow(d,sensitivity); 
        if(v>maxDiff){ 
            maxDiff=v; 
            peakIndex=i; 
        }
    });
    peakLabel.textContent = (peakIndex*sampleInterval/1000).toFixed(2)+" s";

    // Solo actualizar video si autoFollow est√° activado
    if(autoFollow && currentVideo && playVideo.duration){
        playVideo.currentTime = (peakIndex / smoothDiffs.length) * playVideo.duration;
    }
}

/* ===== GRAFICO ===== */
function draw(){
    requestAnimationFrame(draw);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(!smoothDiffs.length) return;
    const h = canvas.height;

    // curva azul
    ctx.beginPath();
    smoothDiffs.forEach((d,i)=>{
        const x=i/smoothDiffs.length*canvas.width;
        const y=h-(Math.pow(d,sensitivity)/maxDiff)*h;
        ctx.lineTo(x,y);
    });
    ctx.strokeStyle="#007bff"; ctx.lineWidth=3; ctx.stroke();

    // barra roja = pico
    const px = peakIndex / smoothDiffs.length * canvas.width;
    ctx.strokeStyle="red"; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(px,0); ctx.lineTo(px,h); ctx.stroke();

// barra naranja = tiempo actual del video
let tx = 0;
if(playVideo.duration) {
    tx = (playVideo.currentTime / playVideo.duration) * canvas.width;
}
ctx.strokeStyle = "orange";
ctx.lineWidth = 2;
ctx.beginPath();
ctx.moveTo(tx, 0);
ctx.lineTo(tx, h);
ctx.stroke();

}
draw();

/* ===== INTERACCI√ìN GRAFICO ===== */
canvas.onmousedown = e=>{ dragging=true; autoFollow=false; moveGraph(e); };
window.onmousemove = e=>dragging && moveGraph(e);
window.onmouseup = ()=>dragging=false;
function moveGraph(e){
    if(!playVideo.duration) return;
    autoFollow = false; // desactiva autoFollow al mover el gr√°fico
    const r = canvas.getBoundingClientRect();
    const x = Math.min(Math.max(e.clientX - r.left,0), r.width);
    playVideo.currentTime = (x / r.width) * playVideo.duration;
}
canvas.ondblclick = ()=>{ if(!playVideo.duration || !smoothDiffs.length) return; playVideo.currentTime = (peakIndex/smoothDiffs.length)*playVideo.duration; };

/* ===== LISTA DE ARCHIVOS ===== */
function addToList(v){
    const row = document.createElement("div");
    row.className = "file-row";

    const btn = document.createElement("button");
    btn.className = "file-btn";
    btn.textContent = v.name;

    btn.onclick = () => selectVideo(v);

    const s = document.createElement("button");
    s.className = "save-btn";
    s.textContent = "üíæ";
    s.onclick = () => download(v);

    row.append(btn, s);
    fileList.prepend(row);

    // üîë CLAVE: guardar referencia al bot√≥n
    v._btn = btn;
}

/* ===== SELECCIONAR VIDEO ===== */
function selectVideo(v) {
    currentVideo = v;
    autoFollow = false;

    // Actualizamos la fuente del video
    playVideo.src = v.url;

    // Actualizamos selecci√≥n visual en la lista
document.querySelectorAll(".file-btn")
    .forEach(b => b.classList.remove("active"));

if (v._btn) {
    v._btn.classList.add("active");
}

    // Copiamos los datos del video para el gr√°fico
    if (v.smoothDiffs && v.smoothDiffs.length) {
        smoothDiffs = [...v.smoothDiffs];
        peakIndex = v.peakIndex || 0;
        maxDiff = Math.max(...smoothDiffs.map(d => Math.pow(d, sensitivity)), 1);
    } else {
        smoothDiffs = [];
        peakIndex = 0;
        maxDiff = 1;
    }

    // Esperamos a que el video cargue su duraci√≥n
playVideo.onloadedmetadata = () => {
    if (playVideo.duration && smoothDiffs.length) {
        playVideo.currentTime = (peakIndex / smoothDiffs.length) * playVideo.duration;
        playVideo.pause();                // Pausa el video
        playPauseBtn.textContent = "‚ñ∂Ô∏è"; // Actualiza bot√≥n a reproducir
    }

    // Aplica velocidad activa
    const activeSpeedBtn = document.querySelector(".speed-btn.active");
    if(activeSpeedBtn) {
        playVideo.playbackRate = +activeSpeedBtn.dataset.speed;
    }
};
};

function download(v){
    const a=document.createElement("a");
    a.href=URL.createObjectURL(v.blob);
    a.download=v.name;
    a.click();
}

/* ===== METADATA LOAD ===== */
playVideo.onloadedmetadata=()=>{};
const openFileBtn = document.getElementById("openFileBtn");
const fileInput = document.getElementById("fileInput");

// Abrir selector de archivos
openFileBtn.onclick = () => fileInput.click();

// Cuando el usuario selecciona archivos
fileInput.onchange = async e => {
    const files = Array.from(e.target.files);
    if (!files.length) return;

    const analyzedVideos = [];

    for (const file of files) {
        const url = URL.createObjectURL(file);
        const v = {
            url,
            name: file.name,
            blob: file,
            smoothDiffs: [], // se llenar√° con el an√°lisis
            peakIndex: 0
        };
        addToList(v);

        // Espera a que el an√°lisis termine
        await new Promise(resolve => analyzeVideoFile(v, resolve));

        analyzedVideos.push(v);
    }

    // Selecciona autom√°ticamente el primer video a√±adido con an√°lisis
    selectVideo(analyzedVideos[0]);

    fileInput.value = "";
};

// ===== AN√ÅLISIS DE VIDEOS CARGADOS =====
function analyzeVideoFile(videoObj, onComplete) {
    const tempVideo = document.createElement("video");
    tempVideo.src = videoObj.url;
    tempVideo.muted = true;
    tempVideo.preload = "auto";

    const tempCanvas = document.createElement("canvas");
    const tempCtx = tempCanvas.getContext("2d");

    tempVideo.onloadedmetadata = () => {
        tempCanvas.width = 96;
        tempCanvas.height = Math.floor(96 * (tempVideo.videoHeight / tempVideo.videoWidth));

        const diffsLocal = [];
        let lastLum = null, lastColor = null;
        const sampleInterval = 120; // ms
        let time = 0;

        tempVideo.currentTime = time;

tempVideo.onseeked = () => {
    // dibuja el frame
    tempCtx.drawImage(tempVideo, 0, 0, tempCanvas.width, tempCanvas.height);
    const d = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height).data;
    let lum = 0, r = 0, g = 0, b = 0;
    const n = d.length / 4;
    for (let i = 0; i < d.length; i += 4) {
        r += d[i]; g += d[i+1]; b += d[i+2];
        lum += 0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2];
    }
    lum /= n; r/=n; g/=n; b/=n;

    if (lastLum !== null) {
        diffsLocal.push(Math.abs(lum - lastLum) + Math.hypot(r - lastColor[0], g - lastColor[1], b - lastColor[2]) * 0.5);
    }

    lastLum = lum;
    lastColor = [r,g,b];

            // Avanzar al siguiente frame
            time += sampleInterval / 1000;
            if (time < tempVideo.duration) {
                tempVideo.currentTime = time;
            } else {
                // An√°lisis completo
const maxD = Math.max(...diffsLocal);
videoObj.smoothDiffs = diffsLocal.map(d => d / maxD);
videoObj.peakIndex = videoObj.smoothDiffs.indexOf(
    Math.max(...videoObj.smoothDiffs.map(d => Math.pow(d, 1)))
);
                // Actualizar gr√°fico si es el video actual
                if (!currentVideo) selectVideo(videoObj);
                if (currentVideo === videoObj) selectVideo(videoObj);

                if (onComplete) onComplete(videoObj);
            }
        };
    };
}
</script>

</body>
</html>
